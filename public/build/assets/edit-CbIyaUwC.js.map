{"version":3,"file":"edit-CbIyaUwC.js","sources":["../../../resources/js/pages/admin/gallery/edit.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport Dropzone from '@/components/Dropzone.vue';\nimport { Button } from '@/components/ui/button';\nimport AppLayout from '@/layouts/AppLayout.vue';\nimport { Head, router } from '@inertiajs/vue3';\nimport { toTypedSchema } from '@vee-validate/zod';\nimport { useForm, useField } from 'vee-validate';\nimport { toast } from 'vue-sonner';\nimport { computed, reactive } from 'vue';\nimport { route } from 'ziggy-js';\nimport FileThumb from '@/components/FileThumb.vue';\nimport type { BreadcrumbItem } from '@/types';\nimport GalleryForm from './_Form.vue';\nimport { galleryBaseSchema, GalleryBaseSchema } from '@/pages/admin/gallery/_schema';\n\nconst props = defineProps<{\n    gallery: App.Data.GalleryData;\n    photospheres: Array<App.Data.PhotosphereData>;\n}>();\n\nconst breadcrumbs: BreadcrumbItem[] = [\n    {\n        title: 'Admin',\n        href: route('admin'),\n    },\n    {\n        title: 'Galleries',\n        href: route('admin.gallery.index'),\n    },\n    {\n        title: `${props.gallery.name} (photosphere: ${props.gallery.photosphere?.name})`,\n        href: route('admin.gallery.show', props.gallery.id),\n    },\n];\n\nconst { handleSubmit } = useForm<GalleryBaseSchema>({\n    validationSchema: toTypedSchema(galleryBaseSchema),\n    initialValues: {\n        name: props.gallery.name,\n        latitude: props.gallery.latitude ?? undefined,\n        longitude: props.gallery.longitude ?? undefined,\n    },\n});\n\nconst latitudeField = useField<number | undefined>('latitude');\nconst longitudeField = useField<number | undefined>('longitude');\n\nconst photosphereImageUrl = computed(() => {\n    // GalleryData includes photosphere (lazy) in some responses; the edit controller currently\n    // passes the model with loaded photosphere, so this should work.\n    const id = (props.gallery as any)?.photosphere?.id ?? (props.gallery as any)?.photosphere_id;\n    if (!id) return null;\n    return route('photosphere.image', id);\n});\n\n// buffer for new uploads\nconst pendingFiles = reactive<File[]>([]);\nfunction addFiles(files: File[]) {\n    for (const f of files) if (f.type.startsWith('image/')) pendingFiles.push(f);\n}\nfunction removePending(idx: number) {\n    pendingFiles.splice(idx, 1);\n}\n\nconst submit = handleSubmit((vals) => {\n    const fd = new FormData();\n    fd.append('name', vals.name);\n    if (vals.latitude !== undefined) fd.append('latitude', String(vals.latitude));\n    if (vals.longitude !== undefined) fd.append('longitude', String(vals.longitude));\n    pendingFiles.forEach((f, i) => fd.append(`photos[${i}]`, f));\n\n    fd.append('_method', 'PUT');\n    router.post(route('api.v1.gallery.update', props.gallery.id), fd, {\n        forceFormData: true,\n        preserveState: false,\n        preserveScroll: true,\n        onSuccess: () => {\n            pendingFiles.splice(0);\n            toast.success('Gallery updated');\n        },\n        onError: (errors) => toast.error('Update failed<br />' + JSON.stringify(errors)),\n    });\n});\n\nfunction updateDescription(photo: object, description: string) {\n    router.put(\n        route('api.v1.photo.update', { photo, description: description }),\n        { description },\n        {\n            onSuccess: () => toast.success('Description saved'),\n            onError: () => toast.error('Could not save description'),\n            preserveScroll: true,\n            preserveState: true,\n        },\n    );\n}\n\nfunction removePhoto(photoId: number) {\n    if (confirm('This action cannot be undone. Are you sure you want to proceed?')) {\n        router.delete(route('api.v1.photo.destroy', { photo: photoId }), {\n            onSuccess: () => toast.success('Photo removed'),\n            onError: () => toast.error('Delete failed'),\n        });\n    }\n}\n</script>\n\n<template>\n    <AppLayout :breadcrumbs=\"breadcrumbs\">\n        <Head :title=\"`Edit Gallery â€” ${props.gallery.name}`\" />\n\n        <div class=\"p-4\">\n            <h1 class=\"mr-3 inline py-3 text-xl\">Gallery editor</h1>\n        </div>\n\n        <form id=\"gallery-edit-form\" class=\"ml-4 max-w-4xl space-y-6\" @submit.prevent=\"submit\">\n            <GalleryForm\n                :picker-src=\"photosphereImageUrl\"\n                :lat=\"latitudeField.value.value ?? null\"\n                :lon=\"longitudeField.value.value ?? null\"\n                @update:lat=\"(v) => latitudeField.setValue(v)\"\n                @update:lon=\"(v) => longitudeField.setValue(v)\"\n            />\n\n            <div class=\"space-y-3\">\n                <label>Add Photos</label>\n                <Dropzone multiple accept=\"image/*\" @files=\"addFiles\" />\n                <div v-if=\"pendingFiles.length\" class=\"grid grid-cols-2 gap-3 md:grid-cols-5\">\n                    <FileThumb v-for=\"(f, idx) in pendingFiles\" :key=\"idx\" :file=\"f\" @remove=\"removePending(idx)\" />\n                </div>\n            </div>\n        </form>\n\n        <div class=\"mt-10 px-4\">\n            <h2 class=\"mb-3 text-lg font-semibold\">Existing Photos</h2>\n            <div class=\"grid grid-cols-2 gap-3 md:grid-cols-4 lg:grid-cols-5\">\n                <FileThumb\n                    v-for=\"photo in props.gallery.photos\"\n                    :key=\"photo.id\"\n                    :photo=\"photo\"\n                    show-description\n                    @description-change=\"(val) => updateDescription(photo, val)\"\n                    @remove=\"removePhoto(photo.id)\"\n                    editable\n                />\n            </div>\n        </div>\n\n        <div class=\"px-4 pb-8 pt-6\">\n            <Button type=\"submit\" form=\"gallery-edit-form\">Save</Button>\n        </div>\n    </AppLayout>\n</template>\n"],"names":["props","__props","breadcrumbs","route","handleSubmit","useForm","toTypedSchema","galleryBaseSchema","latitudeField","useField","longitudeField","photosphereImageUrl","computed","id","pendingFiles","reactive","addFiles","files","f","removePending","idx","submit","vals","fd","i","router","toast","errors","updateDescription","photo","description","removePhoto","photoId","_createBlock","AppLayout","_createVNode","_unref","Head","_createElementVNode","_cache","_withModifiers","args","GalleryForm","v","_hoisted_1","Dropzone","_openBlock","_createElementBlock","_hoisted_2","_Fragment","_renderList","FileThumb","$event","_hoisted_3","_hoisted_4","val","_hoisted_5","Button"],"mappings":"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"}